<br><br>
<div class="container page-conversation-view">
  <div class="row">
    <div class="col-md-5">
      <ul class="list-group">
        <span ng-if="$ctrl.viewer.before.length > 0">
          <li ng-repeat="block in $ctrl.viewer.before" ng-include="'conversationBlock'" class="list-group-item message-block"></li>
          <br><br>
        </span>
        <li ng-alias="block as $ctrl.a" ng-include="'conversationBlock'" class="list-group-item message-block"></li>
        <br><br>
        <li ng-if="$ctrl.viewer.after.length > 0" ng-repeat="block in $ctrl.viewer.after" ng-include="'conversationBlock'" class="list-group-item message-block">
        </li>
      </ul>
    </div>
    <div class="col-md-7">
      <div ng-if="$ctrl.editing.s && !$ctrl.editing.p">
        Messages:<br>
        Retries: 3<br>
        Retry default phrases:
        <br><br>

      </div>
      <div ng-if="$ctrl.editing.s && $ctrl.editing.p">
        {{$ctrl.step[$ctrl.a.s].path[$ctrl.a.p].description}}
        <br><br>
        Confirm?<br>
        Confirm phrases:<br>
        <br>

        <div class="panel panel-default">
          <div class="panel-heading">
            Patterns ({{$ctrl.step[$ctrl.a.s].path[$ctrl.a.p].patterns.length}})
          </div>
          <div class="panel-body">
            <input class="form-control" />
            <br>
            <table class="table table-hover">
              <thead>
                <th>
                  Type
                </th>
                <th>
                  Matches
                </th>
                <th>
                  Response
                </th>
              </thead>
              <tr ng-repeat="pattern in $ctrl.step[$ctrl.a.s].path[$ctrl.a.p].patterns | limitTo: 5">
                <td>
                  {{pattern.type}}
                </td>
                <td>
                  <span ng-if="pattern.type == 'exact'" ng-repeat="phrase in pattern.phrases | limitTo: 5">{{phrase}}<br></span><span ng-if="pattern.phrases.length > 5">+{{pattern.phrases.length - 5}}</span>
                  <span ng-if="pattern.type == 'entity'">{{pattern.entity}} ({{pattern.value || 'all'}})</span>
                  <span ng-if="pattern.type == 'number'">Min: {{pattern.min}}<br>Max: ({{pattern.max}}</span>

                </td>
                <td>
                  {{pattern.messages[0]}}<span ng-if="pattern.messages.length > 1">&nbsp;(+{{pattern.messages.length -1}})</span>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/ng-template" id="conversationBlock">
  <span style="font-size: .8em;color:rgb(84, 84, 84)">Step: {{$ctrl.step[block.s]._id}}</span>
  <br><br>
  <div class="selectable-message" ng-click="$ctrl.setActive(block.s);">
    <div class="message-container message-app" ng-repeat="message in $ctrl.step[block.s].messages" >
      <div class="message-bubble message-app">{{ message }}</div>
    </div>
    <div ng-if="block.active">
      <a href="#" style="font-size = .8em;">Say something...</a>
      <!--<form>
        <input  /> <button class="btn btn-small btn-primary">Say</button>
      </form>-->
      <div ng-if="!$ctrl.step[block.s].path[block.p]" style="text-align: right;">
        <a href="#" style="font-size = .8em;">User says...</a>
      </div>
    </div>
  </div>
  <div class="selectable-message" ng-if="$ctrl.step[block.s].path[block.p]" ng-click="$ctrl.setActive(block.s, block.p)">
    <div class="message-container message-container-user">
      <div ng-if="block.active" style="text-align:left">
        If...&nbsp;
        <!--
          check if accepted, cycle sumbol if retry, hand stop if end, down arrow if passthrough {{response | responseShortname}}
        -->
        <select ng-model="$ctrl.a.p" ng-change="$ctrl.buildViewer()">
          <option ng-repeat="path in $ctrl.step[block.s].paths" value="{{path._id}}">
            {{path.description}}
          </option>
          <option>[Add Path]</option>
        </select>
        <br>

      </div>
      <div class="message-bubble message-user">
        {{ $ctrl.step[block.s].path[block.p].patterns[0].phrases[0] }}
      </div>
    </div>
    <div class="message-container message-app" ng-repeat="message in $ctrl.step[block.s].path[block.p].patterns[0].messages">
      <div class="message-bubble message-app">{{ message }}</div>
    </div>
    <div ng-if="block.active">
      <a href="#" style="font-size = .8em;">Say something...</a>
      <!--<form>
        <input  /> <button class="btn btn-small btn-primary">Say</button>
      </form>-->
      <br><br>
      Then...&nbsp;
      <select ng-model="$ctrl.step[$ctrl.a.s].path[$ctrl.a.p].next" ng-change="$ctrl.buildViewer()">
        <option value="goToStep">Go To Step</option>
        <option value="end">End Conversation</option>
        <option value="retry">Retry Step</option>
      </select>
      &nbsp;&nbsp;
      <span ng-if="$ctrl.step[$ctrl.a.s].path[$ctrl.a.p].next == 'goToStep'">
        {{$ctrl.step[$ctrl.a.s].path[$ctrl.a.p].stepId}}
      </span>
    </div>
  </div>
</script>
