<div class="container page-conversation-view">
  <br>
  <h2>{{$ctrl.m.info.name}}</h2>
  <bR>
  <div class="row">
    <div class="col-md-5">
      <ul class="list-group">
        <span ng-if="$ctrl.viewer.before.length > 0">
          <li ng-repeat="block in $ctrl.viewer.before" ng-include="'conversationBlock'" class="list-group-item message-block"></li>
          <br><br>
        </span>
        <li ng-alias="block as $ctrl.a" ng-include="'conversationBlock'" class="list-group-item message-block"></li>
        <br><br>
        <li ng-if="$ctrl.viewer.after.length > 0" ng-repeat="block in $ctrl.viewer.after" ng-include="'conversationBlock'" class="list-group-item message-block">
        </li>
      </ul>
    </div>
    <div class="col-md-7">
      <div ng-if="$ctrl.editing.s && !$ctrl.editing.p">
        <h3>Step: {{$ctrl.m.step[$ctrl.a.s].name}}</h3>
        <br><br>

      </div>
      <div ng-if="$ctrl.editing.s && $ctrl.editing.p">
        <h3>Path: {{$ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].name}}</h3>
        <br><br>
        Confirm?<br>
        Confirm phrases:<br>
        <br>
        <div ng-if="$ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].next == 'retry'">
          Retries: 3<br>
          Retry default phrases:
        </div>
        <br>


        <div class="panel panel-default">
          <div class="panel-heading">
            Patterns ({{$ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].patterns.length}})
          </div>
          <div class="panel-body">
            <input class="form-control" />
            <br>
            <table class="table table-hover">
              <thead>
                <th>
                  Type
                </th>
                <th>
                  Matches
                </th>
                <th>
                  Response
                </th>
              </thead>
              <tr ng-repeat="pattern in $ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].patterns | limitTo: 5">
                <td>
                  {{pattern.type}}
                </td>
                <td>
                  <span ng-if="pattern.type == 'exact'" ng-repeat="phrase in pattern.phrases | limitTo: 5">{{phrase}}<br></span><span ng-if="pattern.phrases.length > 5">+{{pattern.phrases.length - 5}}</span>
                  <span ng-if="pattern.type == 'entity'">{{pattern.entity}} ({{pattern.value || 'all'}})</span>
                  <span ng-if="pattern.type == 'number'">Min: {{pattern.min}}<br>Max: ({{pattern.max}}</span>

                </td>
                <td>
                  {{pattern.messages[0]}}<span ng-if="pattern.messages.length > 1">&nbsp;(+{{pattern.messages.length -1}})</span>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/ng-template" id="conversationBlock">
  <div style="font-size: .8em;color:rgb(84, 84, 84); text-align: center; padding-top: 10px;">Step {{$ctrl.m.step[block.s]._id}}</div>
  <div class="selectable-block" ng-class="{'selected-block': block.active && !$ctrl.editing.p}" ng-click="$ctrl.setActive(block.s);">
    <div class="message-container message-app" ng-repeat="message in $ctrl.m.step[block.s].messages" >
      <div class="message-bubble message-app">{{ message }}</div>
    </div>
    <div ng-if="block.active && !$ctrl.editing.p">
      <a href="#"  ng-if="$ctrl.editing.focus !== 'appMessage'" style="font-size = .8em;" ng-click="$ctrl.editing.focus = 'appMessage'">Say something...</a>
      <form ng-if="$ctrl.editing.focus == 'appMessage'">
        <input  /> <button>Say</button> <a ng-click="$ctrl.editing.focus = null">Cancel</a>
      </form>
      <div ng-if="!$ctrl.m.step[block.s].path[block.p]" style="text-align: right;">
        <a href="#" ng-if="$ctrl.editing.focus !== 'userMessage'" style="font-size = 0.8em;" ng-click="$ctrl.editing.focus = 'userMessage'">User says...</a>
        <form ng-if="$ctrl.editing.focus == 'userMessage'">
          <input  /> <button>Say</button> <a ng-click="$ctrl.editing.focus = null">Cancel</a>
        </form>
      </div>
    </div>
  </div>
  <div class="selectable-block" ng-class="{'selected-block': block.active && $ctrl.editing.p}" ng-if="$ctrl.m.step[block.s].path[block.p]" ng-click="$ctrl.setActive(block.s, block.p)">
    <div class="message-container message-container-user">
      <div ng-if="block.active && $ctrl.editing.p" style="text-align:left">
        If...<br>
        <select ng-model="$ctrl.pathSelection" ng-change="$ctrl.selectPath($ctrl.pathSelection)">
          <option ng-repeat="path in $ctrl.m.step[block.s].paths" value="{{path._id}}">
            {{path.name}}
          </option>
          <option value="new">[Add Path]</option>
        </select>
        <br>

      </div>
      <div class="message-bubble message-user">
        {{ $ctrl.m.step[block.s].path[block.p].patterns[0] | responseExample }}
      </div>
    </div>
    <div class="message-container message-app" ng-repeat="message in $ctrl.m.step[block.s].path[block.p].patterns[0].messages">
      <div class="message-bubble message-app">{{ message }}</div>
    </div>
    <div ng-if="block.active && $ctrl.editing.p">
      <a href="#" style="font-size = 0.8em;" ng-click="$ctrl.editing.focus = 'appMessage'">Say something...</a>
      <form ng-if="$ctrl.editing.focus == 'appMessage'">
        <input  /> <button>Say</button> <a ng-click="$ctrl.editing.focus = null">Cancel</a>
      </form>
      <br><br>
      Then...&nbsp;
      <br>
      <select ng-model="$ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].next" ng-change="$ctrl.buildViewer()">
        <option value="goTo">Go To</option>
        <option value="end">End Conversation</option>
        <option value="retry">Retry Step</option>
      </select>
      <div ng-if="$ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].next == 'goTo'">
        <select ng-model="$ctrl.m.step[$ctrl.a.s].path[$ctrl.a.p].stepId" ng-change="$ctrl.buildViewer()">
          <option ng-repeat="step in $ctrl.m.step" value="{{step._id}}" ng-hide="step._id == $ctrl.a.s">{{step._id}}: {{step.messages[0]}}</option>
          <option value="">[Select Step]</option>
        </select>
      </div>
    </div>
  </div>
  <div ng-if="block.active && !$ctrl.m.step[$ctrl.a.s].paths" style="padding: 12px">
    Then automatically...&nbsp;
    <br>
    <select ng-model="$ctrl.m.step[$ctrl.a.s].next" ng-change="$ctrl.buildViewer()">
      <option value="goTo">Go To</option>
      <option value="end">End Conversation</option>
    </select>
    <div ng-if="$ctrl.m.step[$ctrl.a.s].next == 'goTo'">
      <select ng-model="$ctrl.m.step[$ctrl.a.s].stepId" ng-change="$ctrl.buildViewer()">
        <option ng-repeat="step in $ctrl.m.step" value="{{step._id}}" ng-hide="step._id == $ctrl.a.s">{{step._id}}: {{step.messages[0]}}</option>
        <option value="">[Select Step]</option>
      </select>
    </div>
  </div>
</script>
