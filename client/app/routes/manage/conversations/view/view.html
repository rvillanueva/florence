<div class="container page-conversation-view">
  <h3>
    {{$ctrl.conversation.name}}
    <button class="btn btn-sm btn-primary pull-right" ng-disabled="$ctrl.isPristine" ng-click="$ctrl.save()">Save</button>
  </h3>
  <br>
  <div class="row">
    <div class="col-md-12">
      <div ng-repeat="ref in $ctrl.conversation.next" ng-include="'stepTree'">
      </div>
      <div ng-if="!$ctrl.conversation.next || $ctrl.conversation.next.length == 0">
        No steps in this conversation. <a href="#">Try adding one.</a>
      </div>
    </div>
  </div>
</div>

<script type="text/ng-template" id="stepTree">
  <div ng-controller="ConversationLineController">
    <div class="convo-line-container">
      <i class="fa expander clickable" ng-class="{'fa-minus-square-o': !hidden,'fa-plus-square': hidden}" ng-show="$ctrl.map[ref.stepId].next.length > 0" ng-click="hidden = !hidden"></i>
      <i class="fa expander" ng-hide="$ctrl.map[ref.stepId].next.length > 0"></i>
      <div class="convo-line-text">
        <a href="#" class="convo-line-text-edit" ng-click="editStep(step)" ng-switch="$ctrl.map[ref.stepId].type">
          <span ng-switch-when="say">{{ $ctrl.map[ref.stepId].text || '[no text]'}}</span>
          <span ng-switch-when="intent"><strong>INTENT: {{ $ctrl.intents[$ctrl.map[ref.stepId].intentId].name || '[untitled intent]'}}</strong></span>
          <span ng-switch-when="fallback"><i>fallback</i></span>
          <span ng-switch-when="container"><i>container</i></span>
          <span ng-switch-default><i style="color:red">error: unknown step type</i></span>
        </a>
      <span ng-show="$ctrl.map[ref.stepId].actions.length > 0">&nbsp;&nbsp;<i class="fa fa-bolt" style="color: rgb(219, 219, 219)"></i></span>
        <span class="convo-dropdown" uib-dropdown>
          &nbsp;&nbsp;&nbsp;<a href="#" uib-dropdown-toggle><i class="fa fa-angle-down" style="font-size: 1.4em"></i></a>
          <ul class="dropdown-menu dropdown-menu-small" uib-dropdown-menu role="menu" aria-labelledby="single-button">
            <li role="menuitem"><a href="#">+ Reference</a></li>
            <li role="menuitem"><a href="#">+ Say</a></li>
            <li role="menuitem"><a href="#">+ Intent</a></li>
            <li role="menuitem"><a href="#">+ Fallback</a></li>
            <li role="menuitem"><a href="#">Move</a></li>
            <li class="divider"></li>
            <li role="menuitem"><a href="#" class="dropdown-danger-item">Remove Reference</a></li>
          </ul>
        </span>
      </div>
    </div>
    <div ng-if="$ctrl.map[ref.stepId].next && $ctrl.map[ref.stepId].next.length > 0 && !hidden">
      <div class="convo-line-indented" ng-repeat="ref in $ctrl.map[ref.stepId].next" ng-include="'stepTree'">
      </div>
    </div>
  </div>
</script>
